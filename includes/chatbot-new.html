<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeepSeek Chatbot</title>
<style>
  body {
    font-family: sans-serif;
    background: #f0f0f0;
    margin: 0;
    padding: 0;
    display: flex;
    min-height: 100vh;
    width: 100vw;
  }

  #chat-container {
    width: 100%;
    background: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    border: none;
  }

  /* Chat header */
  #chat-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    border-bottom: 1px solid #eee;
    background: #fafafa;
  }
  .chat-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    flex: 0 0 32px;
  }
  .chat-meta { display: flex; flex-direction: column; line-height: 1.2; }
  .chat-title { font-weight: 600; }
  .chat-status { font-size: 12px; color: #6b7280; display: flex; align-items: center; gap: 6px; margin-top: 2px; }
  .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 0 0 rgba(34,197,94,0.7); animation: pulse 2s infinite; }
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.7); }
    70% { box-shadow: 0 0 0 8px rgba(34,197,94,0); }
    100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
  }

  #chat {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
  }

  .message {
    margin: 8px 12px;
    padding: 8px 12px;
    border-radius: 12px;
    max-width: 80%;
    word-wrap: break-word;
    white-space: pre-wrap; /* preserve newlines in typed text */
    margin-bottom: 0.6rem;
    padding: 8px 16px;
    border-radius: 20px;
    display: block;
    width: auto;
    max-width: 85%;
    word-wrap: break-word;
    box-sizing: border-box;
    color: #e6eef6;
    font-size: 15px;
    /* font-weight: 300; */
    line-height: 25px;
  }

  #chat {
    display: flex;
    flex-direction: column;
  }

  .user {
    background: #1467cc;
    color: #dff5ff;
    margin-left: auto;
    margin-right: 0;
    text-align: left;
    width: fit-content;
    max-width: 320px;
    box-shadow: 0 6px 18px rgba(11,36,56,0.5);
    margin-top: 24px;
    margin-bottom: 24px;
  }

  .bot {
    background: #E8E8E8;
    margin-right: auto;
    color: #000;
  }

  /* Loader animation for bot typing */
  .loader {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .loader .dot {
    width: 6px;
    height: 6px;
    background: #666;
    border-radius: 50%;
    animation: bounce 1.2s infinite ease-in-out;
  }
  .loader .dot:nth-child(2) { animation-delay: 0.15s; }
  .loader .dot:nth-child(3) { animation-delay: 0.3s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.6; }
    40% { transform: scale(1); opacity: 1; }
  }

  #input-container {
    display: flex;
    border-top: 1px solid #ccc;
  }

  #message {
    flex: 1;
    padding: 10px;
    border: none;
    outline: none;
    font-size: 16px;
  }

  #send {
    padding: 10px 20px;
    border: none;
    background: #007bff;
    color: white;
    cursor: pointer;
  }

  #send:hover {
    background: #0056b3;
  }

  #send:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<div id="chat-container">
  <div id="chat-header">
    <img class="chat-avatar" src="/images/cinema-logo-icon.png" alt="Bot avatar" onerror="this.style.display='none'">
    <div class="chat-meta">
      <div class="chat-title">Alice Assistant</div>
      <div class="chat-status"><span class="status-dot" aria-hidden="true"></span>Active now</div>
    </div>
  </div>
  <div id="chat"></div>
  <div id="input-container">
    <input id="message" type="text" placeholder="Type a message">
    <button id="send">Send</button>
  </div>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('message');
const sendBtn = document.getElementById('send');

// --- Markdown rendering (safe + minimal) ---
function escapeHTML(str) {
  return str.replace(/[&<>"']/g, c => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  })[c]);
}

function sanitizeUrl(url) {
  const u = (url || '').trim();
  if (/^(https?:\/\/|mailto:)/i.test(u)) return u;
  if (/^(\/|\.\/|\.\.\/)/.test(u)) return u; // allow relative
  return '#';
}

function renderMarkdown(text) {
  // Escape HTML first
  let safe = escapeHTML(text);

  // Links: [text](url)
  safe = safe.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (m, label, url) => {
    const href = sanitizeUrl(url);
    const lbl = escapeHTML(label);
    return `<a href="${href}" target="_blank" rel="noopener noreferrer nofollow">${lbl}</a>`;
  });

  // Bold: **text**
  safe = safe.replace(/\*\*([\s\S]+?)\*\*/g, '<strong>$1</strong>');

  return safe;
}

function typeText(el, text, options = {}) {
  const { delay = 8, markdown = false } = options;
  // Type word-by-word while preserving whitespace and newlines
  return new Promise(resolve => {
    const tokens = text.split(/(\s+)/); // keep spaces/newlines as tokens
    let i = 0;
    let buffer = '';
    const timer = setInterval(() => {
      if (i >= tokens.length) {
        clearInterval(timer);
        resolve();
        return;
      }
      buffer += tokens[i++];
      if (markdown) {
        el.innerHTML = renderMarkdown(buffer);
      } else {
        el.textContent = buffer;
      }
      chat.scrollTop = chat.scrollHeight;
    }, delay);
  });
}

async function sendMessage() {
  const message = input.value.trim();
  if (!message) return;
  if (sendBtn.disabled) return; // prevent concurrent sends

  // disable input during request
  sendBtn.disabled = true;
  input.disabled = true;

  // Add user message to chat
  const userDiv = document.createElement('div');
  userDiv.className = 'message user';
  userDiv.textContent = message;
  chat.appendChild(userDiv);

  input.value = '';
  chat.scrollTop = chat.scrollHeight;

  // Create bot placeholder with loader
  const botDiv = document.createElement('div');
  botDiv.className = 'message bot';
  botDiv.innerHTML = '<span class="loader" aria-label="Bot is typing" role="status"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
  chat.appendChild(botDiv);
  chat.scrollTop = chat.scrollHeight;

  try {
    // Call your Vercel serverless function
    const res = await fetch('https://www.alicemadesign.com/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });

    if (!res.ok) throw new Error('Network response was not ok');
    const data = await res.json();
    const reply = (data && (data.reply ?? '')).toString().trim() || 'Sorry, something went wrong.';

  // Replace loader with typed text (markdown-aware)
  botDiv.innerHTML = '';
  const content = document.createElement('span');
  botDiv.appendChild(content);
  await typeText(content, reply, { delay: 80, markdown: true });
  } catch (err) {
    console.error(err);
    botDiv.innerHTML = '';
    botDiv.textContent = 'Error connecting to server.';
    chat.scrollTop = chat.scrollHeight;
  } finally {
    // re-enable input
    sendBtn.disabled = false;
    input.disabled = false;
    input.focus();
  }
}

// Event listeners
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
</script>

</body>
</html>
